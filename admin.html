<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Administrativo - Patricia & Luiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root { 
      --cor-principal: #d4af37; 
      --cor-verde: #27ae60; 
      --cor-vermelho: #e74c3c; 
      --cor-azul: #3498db; 
      --cor-roxo: #9b59b6; 
      --cor-dark: #2c3e50; 
    }
    
    body { font-family: 'Montserrat', sans-serif; background-color: #f0f2f5; margin: 0; color: #333; }
    
    /* Login Estilo Convidados.html */
    #bloqueio { 
      position: fixed; top:0; left:0; width:100%; height:100%; background:#f0f2f5; 
      z-index:9999; display: flex; align-items: center; justify-content: center; 
    }
    .login-card {
      background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      text-align: center; max-width: 350px; width: 90%;
    }
    .login-card i { font-size: 40px; color: var(--cor-dark); margin-bottom: 15px; }
    .login-card input { width: 100%; padding: 12px; margin: 20px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    .login-card button { width: 100%; background: var(--cor-dark); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }

    #menu-inicial { 
      position: fixed; top:0; left:0; width:100%; height:100%; background:white; 
      z-index: 9998; display: none; align-items: center; justify-content: center; flex-direction: column; 
    }

    .container { max-width: 900px; margin: 20px auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    
    .btn-menu { width: 280px; padding: 18px; margin: 8px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: 0.3s; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-p { background: var(--cor-principal); }
    .btn-m { background: var(--cor-azul); }
    .btn-pix-menu { background: var(--cor-roxo); }
    .btn-conv-menu { background: var(--cor-dark); }
    .btn-menu:hover { transform: translateY(-3px); filter: brightness(1.1); }

    .secao-admin { display: none; }
    .btn-voltar { background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; font-weight: bold; }

    /* Layout Presentes e Itens */
    .form-novo, .config-box, .ferramentas-convidados { background: #fdfaf0; padding: 20px; border-radius: 12px; border: 1px solid #f1e4bc; margin-bottom: 20px; }
    .item-admin { border: 1px solid #eee; padding: 15px; border-radius: 12px; margin-bottom: 15px; background: #fff; }
    .item-header { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
    
    /* Corre√ß√£o da Imagem de Presentes */
    .item-header img { 
      width: 80px !important; 
      height: 80px !important; 
      min-width: 80px;
      object-fit: cover; 
      border-radius: 8px; 
      border: 1px solid #ddd;
    }

    /* Busca e Filtros de Convidados */
    .busca-container { margin-bottom: 15px; position: relative; }
    .busca-container i { position: absolute; left: 12px; top: 14px; color: #999; }
    .input-busca { width: 100%; padding: 12px 12px 12px 40px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
    .filtros-lado { display: flex; gap: 10px; margin-bottom: 15px; }
    .btn-filtro { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-weight: bold; }
    .btn-filtro.active { background: var(--cor-dark); color: white; border-color: var(--cor-dark); }

    .input-edit { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 0.95rem; }
    .label-mini { font-size: 10px; color: #999; text-transform: uppercase; font-weight: bold; margin-bottom: 4px; display: block; }
    
    .guest-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f9f9f9; }
    .btn-del { background: var(--cor-vermelho); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
    .btn-save { background: var(--cor-azul); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .btn-upload { background: var(--cor-verde); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; margin-top: 10px; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>

  <div id="bloqueio">
    <div class="login-card">
      <i class="fas fa-lock"></i>
      <h2>Painel Admin</h2>
      <input type="password" id="senhaInput" placeholder="Digite a senha">
      <button onclick="verificarSenha()">Entrar</button>
    </div>
  </div>

  <div id="menu-inicial">
    <h2>Bem-vindo, Noivos!</h2>
    <button class="btn-menu btn-p" onclick="mostrarSecao('presentes')">üéÅ Presentes</button>
    <button class="btn-menu btn-m" onclick="mostrarSecao('mensagens')">üìù Mural de Mensagens</button>
    <button class="btn-menu btn-pix-menu" onclick="mostrarSecao('pix')">üí∏ Chave Pix</button>
    <button class="btn-menu btn-conv-menu" onclick="mostrarSecao('convidados')">üë• Gest√£o de Convidados</button>
  </div>

  <div class="container">
    <button class="btn-voltar" onclick="voltarAoMenu()">‚Üê Voltar ao Menu</button>

    <div id="secao-convidados" class="secao-admin">
      <h1>Controle de Convidados</h1>
      <div class="ferramentas-convidados">
        <h3>Importar Lista (JSON)</h3>
        <input type="file" id="inputJson" accept=".json" style="display: none;" onchange="importarJson(event)">
        <button class="btn-upload" onclick="document.getElementById('inputJson').click()">
            <i class="fas fa-file-import"></i> Carregar Arquivo JSON
        </button>
      </div>

      <div class="busca-container">
        <i class="fas fa-search"></i>
        <input type="text" id="buscaConvidado" class="input-busca" placeholder="Buscar por nome ou telefone..." oninput="filtrarConvidados()">
      </div>

      <div class="filtros-lado">
        <button class="btn-filtro active" id="btn-lado-Todos" onclick="setFiltroLado('Todos')">Todos</button>
        <button class="btn-filtro" id="btn-lado-Luiz" onclick="setFiltroLado('Luiz')">Luiz</button>
        <button class="btn-filtro" id="btn-lado-Patricia" onclick="setFiltroLado('Patricia')">Patricia</button>
      </div>
      <div id="lista-convidados">Carregando convidados...</div>
    </div>

    <div id="secao-presentes" class="secao-admin">
      <h1>Gerenciar Presentes</h1>
      <div class="form-novo">
        <h3>Adicionar Novo Item</h3>
        <input type="text" id="nome" placeholder="Nome do Presente" class="input-edit" style="margin-bottom: 8px;">
        <input type="text" id="imagem" placeholder="Link da Imagem" class="input-edit" style="margin-bottom: 8px;">
        <input type="number" id="total" value="1" min="1" class="input-edit" style="margin-bottom: 12px;">
        <button onclick="adicionarPresente()" class="btn-save" style="width:100%; background: var(--cor-verde);">Cadastrar Item</button>
      </div>
      <div id="lista-presentes">Carregando itens...</div>
    </div>

    <div id="secao-mensagens" class="secao-admin">
      <h1>Mural de Mensagens</h1>
      <div id="lista-mensagens">Carregando...</div>
    </div>

    <div id="secao-pix" class="secao-admin">
      <h1>Configurar Chave Pix</h1>
      <div class="config-box">
        <label class="label-mini">Chave Pix Atual</label>
        <input type="text" id="inputChavePix" class="input-edit">
        <button onclick="salvarPix()" class="btn-save" style="width:100%; margin-top: 15px; background: var(--cor-roxo);">Atualizar Chave</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // Configura√ß√µes do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCTBqA3PVyxQmIvk8k7Ia1HIeGsci_rqdY",
      authDomain: "lista-casamento-f19c4.firebaseapp.com",
      projectId: "lista-casamento-f19c4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Login e Navega√ß√£o
    function verificarSenha() {
      if (document.getElementById("senhaInput").value === "1234") {
        document.getElementById("bloqueio").style.display = "none";
        document.getElementById("menu-inicial").style.display = "flex";
      } else { alert("Senha incorreta!"); }
    }

    function mostrarSecao(tipo) {
      document.getElementById("menu-inicial").style.display = "none";
      document.querySelectorAll('.secao-admin').forEach(s => s.style.display = "none");
      document.getElementById("secao-" + tipo).style.display = "block";
      if(tipo === 'pix') carregarPix();
      if(tipo === 'convidados') carregarConvidados();
    }

    function voltarAoMenu() {
      document.getElementById("menu-inicial").style.display = "flex";
      document.querySelectorAll('.secao-admin').forEach(s => s.style.display = "none");
    }

    // --- L√ìGICA CONVIDADOS ---
    let filtroLadoAtual = 'Todos';
    let listaLocalConvidados = [];

    function carregarConvidados() {
      db.collection("convidados").onSnapshot(snap => {
        listaLocalConvidados = [];
        snap.forEach(doc => { listaLocalConvidados.push({ id: doc.id, ...doc.data() }); });
        filtrarConvidados();
      });
    }

    function setFiltroLado(lado) {
        filtroLadoAtual = lado;
        document.querySelectorAll('.btn-filtro').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-lado-' + lado).classList.add('active');
        filtrarConvidados();
    }

    function filtrarConvidados() {
        const termo = document.getElementById("buscaConvidado").value.toLowerCase();
        const div = document.getElementById("lista-convidados");
        div.innerHTML = "";
        listaLocalConvidados.filter(c => {
            const bateLado = (filtroLadoAtual === 'Todos' || c.lado === filtroLadoAtual);
            const bateBusca = (c.nome.toLowerCase().indexOf(termo) > -1 || (c.telefone + "").indexOf(termo) > -1);
            return bateLado && bateBusca;
        }).sort((a,b) => a.nome.localeCompare(b.nome)).forEach(c => {
            const card = document.createElement("div");
            card.className = "item-admin guest-row";
            card.innerHTML = "<div><strong>" + c.nome + "</strong><br><small>" + c.telefone + " | Lado: " + c.lado + "</small></div>" +
                             "<button class='btn-del' onclick='excluirConvidado(\"" + c.id + "\")'><i class='fas fa-trash'></i></button>";
            div.appendChild(card);
        });
    }

    function excluirConvidado(id) { if(confirm("Excluir convidado?")) db.collection("convidados").doc(id).delete(); }

    function importarJson(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const dados = JSON.parse(e.target.result);
                dados.forEach(obj => {
                    db.collection("convidados").add({
                        nome: obj.nome, telefone: (obj.telefone + ""), lado: obj.lado, confirmado: null
                    });
                });
                alert("Importa√ß√£o realizada!");
            } catch (err) { alert("Erro no JSON. Verifique as aspas e os colchetes."); }
        };
        reader.readAsText(file);
    }

    // --- MURAL DE MENSAGENS (Corrigido sem orderBy para evitar travar) ---
    db.collection("mensagens").onSnapshot(snap => {
      var div = document.getElementById("lista-mensagens");
      if(!div) return;
      div.innerHTML = "";
      if(snap.empty) div.innerHTML = "Nenhuma mensagem ainda.";
      snap.forEach(doc => {
        var m = doc.data(), id = doc.id;
        var card = document.createElement("div");
        card.className = "item-admin";
        card.innerHTML = "<label class='label-mini'>Mensagem de " + (m.nome || "Convidado") + "</label>" +
          "<input type='text' id='mt-" + id + "' value='" + m.texto + "' class='input-edit'>" +
          "<div style='margin-top:10px'>" +
            "<button class='btn-save' onclick='salvarM(\"" + id + "\")'>Salvar</button> " +
            "<button class='btn-del' onclick='excluirM(\"" + id + "\")'>Excluir</button>" +
          "</div>";
        div.appendChild(card);
      });
    });

    function salvarM(id) { db.collection("mensagens").doc(id).update({ texto: document.getElementById("mt-"+id).value }).then(() => alert("Salva!")); }
    function excluirM(id) { if(confirm("Excluir?")) db.collection("mensagens").doc(id).delete(); }

    // --- PRESENTES ---
    function adicionarPresente() {
      var n = document.getElementById("nome").value, i = document.getElementById("imagem").value, t = parseInt(document.getElementById("total").value);
      if (!n || !i) return alert("Preencha tudo!");
      db.collection("presentes").add({ nome: n, imagem: i, total: t, recebidos: 0 }).then(() => {
        alert("Cadastrado!"); document.getElementById("nome").value = ""; document.getElementById("imagem").value = "";
      });
    }

    db.collection("presentes").onSnapshot(snap => {
      var div = document.getElementById("lista-presentes");
      div.innerHTML = "";
      snap.forEach(doc => {
        var p = doc.data(), id = doc.id;
        var item = document.createElement("div");
        item.className = "item-admin";
        item.innerHTML = "<div class='item-header'><img src='" + p.imagem + "'>" +
          "<div style='flex-grow:1'><label class='label-mini'>Nome</label><input type='text' id='n-" + id + "' value='" + p.nome + "' class='input-edit'></div></div>" +
          "<div style='display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px;'>" +
          "<div><label class='label-mini'>Total</label><input type='number' id='t-" + id + "' value='" + p.total + "' class='input-edit'></div>" +
          "<div><label class='label-mini'>Ganhos</label><input type='number' id='r-" + id + "' value='" + p.recebidos + "' class='input-edit'></div></div>" +
          "<button class='btn-save' style='width:75%' onclick='salvarP(\"" + id + "\")'>Salvar</button> " +
          "<button class='btn-del' style='width:20%' onclick='excluirP(\"" + id + "\")'><i class='fas fa-trash'></i></button>";
        div.appendChild(item);
      });
    });

    function salvarP(id) {
      db.collection("presentes").doc(id).update({
        nome: document.getElementById("n-"+id).value,
        total: parseInt(document.getElementById("t-"+id).value),
        recebidos: parseInt(document.getElementById("r-"+id).value)
      }).then(() => alert("Salvo!"));
    }
    function excluirP(id) { if(confirm("Excluir?")) db.collection("presentes").doc(id).delete(); }

    function carregarPix() { db.collection("config").doc("pix").get().then((doc) => { if (doc.exists) document.getElementById("inputChavePix").value = doc.data().chave; }); }
    function salvarPix() { db.collection("config").doc("pix").set({ chave: document.getElementById("inputChavePix").value }).then(() => alert("Pix salvo!")); }
  </script>
</body>
</html>
